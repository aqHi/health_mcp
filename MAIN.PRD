下面是一个**完整、从零可读、可以直接复制保存为 `PRD.md` 的需求文档**。
我不会再引用“见前文/见上文”，所有信息都在本文件里写全了。

---

# 健康数据 MCP Server 产品需求文档（PRD）

* 版本：**v2.0**
* 状态：草案（内容完整，可直接用于架构设计与开发拆分）
* 作者：aqHi & AI
* 最后更新时间：2025-XX-XX

---

## 1. 项目背景

#### 1.1 现状

个人健康管理场景中，用户会在各种渠道零散地记录和查看健康相关信息，例如：

* 日常身体指标：身高、体重、体脂率、BMI、心率、血压等
* 医学检查指标：血糖、血脂、尿酸、肝肾功能等
* 运动数据：跑步、骑行等的距离、配速、步频、心率、功率、卡路里等

这些数据的典型来源包括：

* 与 AI 的自然语言对话
* 医院体检报告（PDF、图片等）
* 医学检查报告截图
* 运动 / 健身 App 截图
* 可穿戴设备数据导出（手表、跑步表等）

目前的问题：

1. 各个对话会话之间**没有统一的数据中台**，数据无法长期沉淀。
2. 健康数据**格式混乱、缺乏统一标准**，不利于后续趋势分析。
3. 用户重复上传体检报告 / 截图时，容易造成**重复数据**。
4. 在 AI 层做复杂统计逻辑，效率低、易出错。

#### 1.2 目标

建设一个符合 **MCP（Model Context Protocol）** 的标准化服务（MCP Server），作为 AI 的健康数据中台，提供：

1. **数据写入**：支持 AI 将结构化的健康数据写入系统（单条 / 批量）。
2. **数据查询**：支持按指标、时间、标签、来源等条件查询历史记录。
3. **趋势分析**：提供结构化的趋势统计（时间序列 + 简单统计值）。
4. **指标标准字典**：统一指标类型、单位和结构，指导 AI 正确汇报。
5. **多来源支持**：记录数据来源（对话、文档 OCR、App 截图、设备等）。
6. **去重机制**：避免同一条数据（尤其是体检报告、截图）重复写入。
7. **删除能力**：支持按记录 ID 删除数据。
8. **可扩展性**：指标体系、数据结构和 API 均可平滑扩展。

#### 1.3 非目标（本期不做）

* 不在 Server 端做 OCR。OCR 和文档/截图理解由 AI / 上层应用完成。
* 不负责渲染可视化前端大盘，只提供数据与趋势接口。
* 不做复杂医学诊断，只提供数据支持与简单统计。

---

## 2. 典型使用场景

### 2.1 文本对话记录健康数据

用户在对话中说：

* “我今天早上体重 72 公斤，体脂 19%。”
* “昨天空腹血糖 5.8 mmol/L。”
* “刚跑完 5 公里，配速 5 分 40 秒，步频 168。”

AI 解析出结构化数据后，通过 MCP：

* 使用 `health_store_metric` 多次写入对应指标

  * `body/weight`、`body/body_fat_rate`
  * `medical/blood_glucose`
  * `sport/running_session`

所有记录均带上：

* `source = "chat_input"`
* 对应 `timestamp`（可以是用户给出的时间，也可推断为当前时间）

---

### 2.2 上传体检报告（文档/图片）

用户上传一张医院体检报告图片（类似你提供的第一张图）：

* 报告上包含总胆红素、肌酐、尿酸、血脂四项、ALT、AST、GGT、总蛋白、白蛋白、球蛋白等。

AI：

1. 对图片进行 OCR，并识别出项目名、结果值、单位、参考区间。
2. 把这些项目映射到系统指标字典（如 `medical/uric_acid`、`medical/creatinine` 等）。
3. 将每一项转换为结构化记录，调用 MCP：

   * 当一次体检结果包含多项指标时，调用 `health_batch_store_metrics` 批量写入。
   * 对所有记录设置：

     * `source = "ocr_document"`
     * `metadata.file_hash` = 体检报告图片 hash
     * `metadata.raw_text` = 该指标所在行的原始文本
4. 系统对每条记录计算去重 hash，如已存在相同数据，则标记为重复，不重复写入。

---

### 2.3 上传运动截图

用户上传某运动 App 的跑步记录截图（类似你提供的第二张图）：

* 跑步：距离 15.01km，用时 1:44:30，海拔爬升 62m，平均功率 207W，平均步频 177spm，平均心率 158bpm，总卡路里 1445。

AI：

1. 对截图进行 OCR + 布局理解。

2. 识别跑步各项数据，映射到指标字典：

   * 类型：`sport/running_session`
   * `value` 为 object，包含 distance_km、duration_sec、avg_pace_sec_per_km、avg_cadence、avg_heart_rate、elevation_gain_m、total_kcal 等。

3. 调用 MCP：

   * 使用 `health_store_metric` 写入一条记录。
   * `source = "app_screenshot"`
   * `metadata.file_hash` = 截图 hash
   * `metadata.raw_text` = OCR 结果

4. 去重逻辑防止同一截图多次写入。

---

### 2.4 用户询问健康趋势

用户：

* “过去 3 个月，我的体脂率有没有下降？”
* “最近 10 次跑步的平均配速有提升吗？”

AI：

1. 调用 `health_trend_summary`：

   * type = `body/body_fat_rate`
   * group_by = week/month
2. 根据返回的时间序列 `points` 和 `stats.slope` 给出趋势判断。
3. 对跑步配速类似，使用 `sport/running_session`，`metric_field = "avg_pace_sec_per_km"`。

---

### 2.5 查询与删除记录

用户：

* “我最近 5 次体重是多少？”
* “帮我删除昨天那次跑步记录。”

AI：

1. 查询：

   * 调用 `health_query_metrics`，type = `body/weight`，limit=5，order="desc"。
2. 删除：

   * 先通过查询获得对应跑步记录的 record_id。
   * 再调用 `health_delete_record` 删除该记录。

---

## 3. 技术与架构约束

### 3.1 技术栈

* 语言：**Python 3.x**
* Web 框架：**FastAPI**
* 数据库：**MySQL**
* 缓存：**Redis**
* 协议：

  * MCP（Model Context Protocol），使用 JSON-RPC 2.0
  * 内部也可暴露 RESTful API，供调试与非 MCP 客户端使用
* 部署：**docker-compose** 编排，开箱即用

  * app（MCP + REST）
  * mysql
  * redis
  * adminer / phpMyAdmin（可选，仅开发环境）

### 3.2 架构概览

```text
LLM / AI 应用
      │
      │ MCP（tools.list / tools.call）
      ▼
健康数据 MCP Server（FastAPI）
      ├── MCP 适配层（tools 定义与调用分发）
      ├── REST API 层（可选）
      ├── Service 层（业务逻辑：写入、查询、趋势、去重）
      ├── Repository 层（MySQL 持久化）
      └── Cache 层（Redis）
```

---

## 4. 数据模型与指标标准字典

### 4.1 核心概念

* **Metric（指标）**：例如体重、体脂率、血糖、尿酸、跑步 session。
* **type_code（指标类型编码）**：统一的字符串，如：

  * `body/weight`
  * `body/body_fat_rate`
  * `medical/blood_glucose`
  * `medical/uric_acid`
  * `sport/running_session`
* **Record（记录）**：某一时间点的某一项或一组健康数据。

---

### 4.2 MySQL 概念表设计（字段描述）

#### 4.2.1 表：`metric_catalog`（指标标准字典）

用途：定义每一个标准指标的元信息。

字段说明：

* `id`：主键

* `type_code`：指标类型编码（如 `body/weight`），唯一

* `category`：指标分类（如 `body` / `medical` / `sport`）

* `name_zh`：指标中文名称（例如“体重”）

* `name_en`：指标英文名称（例如“Body Weight”）

* `description`：指标详细说明（含测量方式、含义等）

* `default_unit`：默认单位（如 `kg` / `%` / `mmol/L` / `km` / `min/km`）

* `value_type`：值类型：

  * `number`
  * `string`
  * `object`

* `value_schema`：JSON，描述 `value` 为 object 时的字段结构，例如：

  ```json
  {
    "distance_km": "number",
    "duration_sec": "number",
    "avg_pace_sec_per_km": "number",
    "avg_cadence": "number",
    "avg_heart_rate": "number"
  }
  ```

* `default_tags`：JSON，推荐默认 tags，例如 `{ "sport_type": "running" }`

* `recommended_range`：JSON，指标推荐值范围，例如 `{ "min": 3.9, "max": 6.1 }`

* `decimals`：建议保留的小数位数

* `hash_keys`：JSON 数组，指定参与去重 hash 计算的字段列表（如 `["type", "timestamp", "value"]`）

* `allow_composite_input`：是否允许一条输入中写入多个此类指标（体检时同一报告多项指标）

* `status`：状态（`active` / `deprecated`）

* `created_at`：创建时间

* `updated_at`：更新时间

---

#### 4.2.2 表：`metric_alias`（指标别名表）

用途：建立自然语言名称 → type_code 的映射，方便 AI / OCR 解析后的文本匹配到标准指标。

字段说明：

* `id`：主键
* `type_code`：对应的标准指标编码（外键指向 `metric_catalog.type_code`）
* `alias`：别名文本，例如“血糖”“空腹血糖”“FPG”
* `language`：语种，如 `zh-CN` / `en-US`
* `match_type`：匹配方式

  * `exact`：完全相等
  * `contains`：包含（适合中文）
  * `regex`：正则匹配
* `priority`：整数，匹配优先级（数值越大越优先）
* `created_at`：创建时间

---

#### 4.2.3 表：`health_records`（健康数据记录）

用途：存储所有用户的具体健康数据记录。

字段说明：

* `id`：主键

* `user_id`：用户 ID，由上层系统定义和管理

* `type`：指标类型（即 `metric_catalog.type_code`）

* `value`：JSON，指标具体数值，可为：

  * 单值：直接存 number 或 string
  * 复合值：以 object 形式存多个字段（如跑步距离、配速等）

* `unit`：主值单位，例如 `kg`、`%`、`mmol/L`、`km`

* `tags`：JSON，标签字典，例如：

  ```json
  {
    "fasting": true,
    "sport_type": "running",
    "from_report_date": "2025-09-21"
  }
  ```

* `source`：数据来源字符串，具体取值见 §4.3

* `metadata`：JSON，扩展元信息，例如：

  * `file_hash`：原始文档或截图的 hash
  * `raw_text`：OCR 提取的原始行文本
  * `confidence`：OCR 或解析置信度
  * `device_name`、`app_name` 等

* `timestamp`：记录发生时间（测量时间或运动开始时间）

* `created_at`：记录写入时间

* `updated_at`：最后更新（暂不支持更新，预留）

---

#### 4.2.4 表：`health_record_hash`（去重 hash 表）

用途：实现去重逻辑。

字段说明：

* `hash`：字符串，去重计算出的 hash 值
* `record_id`：关联的 health_records.id
* `created_at`：创建时间

约束：

* `hash` 字段唯一索引。

---

### 4.3 数据来源（source）字段规范

`health_records.source` 字段取值范围（字符串枚举）：

* `chat_input`：用户在对话中直接描述的健康数据
* `ocr_document`：通过体检报告 / 医学检查报告 OCR 得到的数据
* `app_screenshot`：通过运动 App 截图解析得到的数据
* `device`：直接来源于可穿戴设备 / API（如 Garmin/Apple Watch）
* `manual_upload`：通过用户上传 CSV/JSON 等结构化文件导入
* `system`：系统自动生成或纠正的记录

---

### 4.4 去重机制设计

去重目标：

* 同一体检报告多次上传不重复记多遍。
* 同一张运动截图多次发送只记一条。
* 对话中重复解析同一字段，避免重复记录。

去重方案：

1. 在写入前，服务根据记录内容计算唯一 hash：

   * 推荐组合：`user_id` + `type` + `timestamp` + `normalized_value`
   * `normalized_value` 为 value 字段 JSON 经过排序和规范化后的字符串
2. 将该 hash 与 `health_record_hash.hash` 做查重：

   * 若不存在：

     * 写入 `health_records` 新记录
     * 同时插入 `health_record_hash`（hash, record_id）
   * 若已存在：

     * 不新建记录，返回 `duplicated=true`，并返回原 `record_id`

---

## 5. MCP 工具设计

MCP Server 名称（建议）：`health-tracker`

对外暴露以下工具（tools）：

1. `health_store_metric` —— 写入单条健康数据（带去重）
2. `health_batch_store_metrics` —— 批量写入健康数据
3. `health_query_metrics` —— 查询原始记录
4. `health_trend_summary` —— 生成趋势统计
5. `health_list_metric_types` —— 查询用户已有指标类型
6. `health_get_metric_catalog` —— 获取系统指标标准字典
7. `health_delete_record` —— 删除指定记录

以下都给出**输入/输出 JSON Schema 规范**，方便直接映射到代码。

---

### 5.1 工具：`health_store_metric`

#### 5.1.1 功能说明

* 存储一条健康数据记录。
* 自动执行去重判断。
* 适用于：

  * 文本对话中出现的单条记录
  * 单次截图解析结果
  * 开发调试

#### 5.1.2 输入参数 Schema

```json
{
  "type": "object",
  "title": "HealthStoreMetricInput",
  "required": ["user_id", "type", "timestamp"],
  "properties": {
    "user_id": {
      "type": "string",
      "description": "用户唯一标识，由上层系统控制。"
    },
    "type": {
      "type": "string",
      "description": "指标类型编码，建议使用 metric_catalog 中的 type_code，如 body/weight、medical/blood_glucose、sport/running_session。"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "数据发生时间（测量时间或运动开始时间），ISO8601，例如 2025-01-20T09:00:00Z。"
    },
    "value": {
      "description": "指标主值。简单指标用 number，复杂指标用 object。",
      "oneOf": [
        { "type": "number" },
        { "type": "string" },
        { "type": "object", "additionalProperties": true }
      ]
    },
    "unit": {
      "type": "string",
      "description": "主值单位，如 kg, %, mmol/L, km, min/km。对于 object 类型，可留空或在 value 内定义。"
    },
    "tags": {
      "type": "object",
      "description": "标签字典，用于筛选和语义标记，例如 {\"fasting\": true, \"sport_type\": \"running\"}。",
      "additionalProperties": {
        "oneOf": [
          { "type": "string" },
          { "type": "number" },
          { "type": "boolean" }
        ]
      }
    },
    "source": {
      "type": "string",
      "description": "数据来源，例如 chat_input、ocr_document、app_screenshot、device、manual_upload、system。"
    },
    "metadata": {
      "type": "object",
      "description": "扩展元信息，不用于筛选，例如 {\"file_hash\": \"...\", \"raw_text\": \"...\", \"confidence\": 0.98}。",
      "additionalProperties": true
    }
  }
}
```

#### 5.1.3 输出结果 Schema

```json
{
  "type": "object",
  "title": "HealthStoreMetricOutput",
  "required": ["success", "duplicated"],
  "properties": {
    "success": {
      "type": "boolean",
      "description": "写入过程是否成功（包括重复情况）。"
    },
    "duplicated": {
      "type": "boolean",
      "description": "是否命中去重逻辑，如为 true 则表示已存在相同记录。"
    },
    "record_id": {
      "type": "string",
      "description": "新写入或已存在记录的 ID。"
    },
    "message": {
      "type": "string",
      "description": "错误或提示信息。"
    }
  }
}
```

---

### 5.2 工具：`health_batch_store_metrics`

#### 5.2.1 功能说明

* 批量写入多条健康记录。
* 每条记录都执行去重。
* 典型应用：

  * 体检报告解析后一次性写入多项指标。
  * 某次运动 session 解析出多种指标（跑步 + 心率 + 功率）。

#### 5.2.2 输入参数 Schema

```json
{
  "type": "object",
  "title": "HealthBatchStoreMetricsInput",
  "required": ["user_id", "records"],
  "properties": {
    "user_id": {
      "type": "string",
      "description": "用户唯一标识。批量中所有记录属于同一用户。"
    },
    "records": {
      "type": "array",
      "description": "要写入的记录列表。",
      "items": {
        "type": "object",
        "required": ["type", "timestamp"],
        "properties": {
          "type": {
            "type": "string"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "value": {
            "oneOf": [
              { "type": "number" },
              { "type": "string" },
              { "type": "object", "additionalProperties": true }
            ]
          },
          "unit": {
            "type": "string"
          },
          "tags": {
            "type": "object",
            "additionalProperties": {
              "oneOf": [
                { "type": "string" },
                { "type": "number" },
                { "type": "boolean" }
              ]
            }
          },
          "source": {
            "type": "string"
          },
          "metadata": {
            "type": "object",
            "additionalProperties": true
          }
        }
      }
    }
  }
}
```

#### 5.2.3 输出结果 Schema

```json
{
  "type": "object",
  "title": "HealthBatchStoreMetricsOutput",
  "required": ["success", "total_count", "inserted_count", "duplicate_count"],
  "properties": {
    "success": {
      "type": "boolean",
      "description": "批量写入是否成功（如果部分失败，可视为 false，并在 details 中说明）。"
    },
    "total_count": {
      "type": "integer",
      "description": "输入记录总数。"
    },
    "inserted_count": {
      "type": "integer",
      "description": "成功插入的新记录数量。"
    },
    "duplicate_count": {
      "type": "integer",
      "description": "被标记为重复、未新建记录的数量。"
    },
    "record_ids": {
      "type": "array",
      "description": "与输入记录一一对应的 record_id（重复时返回已有记录的 ID，失败则为 null）。",
      "items": {
        "type": ["string", "null"]
      }
    },
    "details": {
      "type": "array",
      "description": "可选的详细结果信息，用于开发调试。",
      "items": {
        "type": "object",
        "properties": {
          "index": { "type": "integer" },
          "success": { "type": "boolean" },
          "duplicated": { "type": "boolean" },
          "record_id": { "type": "string" },
          "message": { "type": "string" }
        }
      }
    }
  }
}
```

---

### 5.3 工具：`health_query_metrics`

#### 5.3.1 功能说明

* 根据条件查询原始记录列表。
* 支持：

  * 按指标类型过滤
  * 按时间范围过滤
  * 按 tags / source 过滤
  * 限制条数 + 排序

#### 5.3.2 输入参数 Schema

```json
{
  "type": "object",
  "title": "HealthQueryMetricsInput",
  "required": ["user_id"],
  "properties": {
    "user_id": {
      "type": "string",
      "description": "用户 ID。"
    },
    "types": {
      "type": "array",
      "description": "要查询的指标类型列表，例如 [\"body/weight\", \"body/body_fat_rate\"]。为空或省略表示不限类型。",
      "items": { "type": "string" }
    },
    "start_time": {
      "type": "string",
      "format": "date-time",
      "description": "起始时间（包含），可选。"
    },
    "end_time": {
      "type": "string",
      "format": "date-time",
      "description": "结束时间（包含），可选。"
    },
    "tags": {
      "type": "object",
      "description": "标签过滤条件，例如 {\"sport_type\": \"running\"}。当前逻辑为等值匹配。",
      "additionalProperties": {
        "oneOf": [
          { "type": "string" },
          { "type": "number" },
          { "type": "boolean" }
        ]
      }
    },
    "sources": {
      "type": "array",
      "description": "数据来源过滤条件，例如 [\"chat_input\", \"ocr_document\"]。",
      "items": { "type": "string" }
    },
    "limit": {
      "type": "integer",
      "description": "最多返回多少条记录，默认 100，最大 1000。",
      "default": 100,
      "minimum": 1,
      "maximum": 1000
    },
    "order": {
      "type": "string",
      "description": "按 timestamp 排序方式：\"asc\" 或 \"desc\"，默认 desc。",
      "enum": ["asc", "desc"],
      "default": "desc"
    }
  }
}
```

#### 5.3.3 输出结果 Schema

```json
{
  "type": "object",
  "title": "HealthQueryMetricsOutput",
  "required": ["records"],
  "properties": {
    "records": {
      "type": "array",
      "description": "匹配条件的记录列表。",
      "items": {
        "type": "object",
        "required": ["record_id", "user_id", "type", "timestamp"],
        "properties": {
          "record_id": { "type": "string" },
          "user_id": { "type": "string" },
          "type": { "type": "string" },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "value": {
            "oneOf": [
              { "type": "number" },
              { "type": "string" },
              { "type": "object", "additionalProperties": true }
            ]
          },
          "unit": { "type": "string" },
          "tags": { "type": "object", "additionalProperties": true },
          "source": { "type": "string" },
          "metadata": { "type": "object", "additionalProperties": true },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      }
    }
  }
}
```

---

### 5.4 工具：`health_trend_summary`

#### 5.4.1 功能说明

* 对指定指标做趋势统计分析。
* 返回时间序列和简单统计信息。
* 适用于回答：“有没有变好 / 变差”、“最近几个月趋势如何” 等问题。

#### 5.4.2 输入参数 Schema

```json
{
  "type": "object",
  "title": "HealthTrendSummaryInput",
  "required": ["user_id", "type"],
  "properties": {
    "user_id": {
      "type": "string",
      "description": "用户 ID。"
    },
    "type": {
      "type": "string",
      "description": "指标类型编码，例如 body/body_fat_rate、medical/blood_glucose、sport/running_session。"
    },
    "start_time": {
      "type": "string",
      "format": "date-time",
      "description": "趋势统计起始时间，可选。"
    },
    "end_time": {
      "type": "string",
      "format": "date-time",
      "description": "趋势统计结束时间，可选。"
    },
    "group_by": {
      "type": "string",
      "description": "时间聚合粒度：raw（不聚合）、day、week、month。",
      "enum": ["raw", "day", "week", "month"],
      "default": "raw"
    },
    "metric_field": {
      "type": "string",
      "description": "当 value 为 object 时，指定要统计的字段名，例如 distance_km 或 avg_pace_sec_per_km。对于数值型指标可留空。"
    }
  }
}
```

#### 5.4.3 输出结果 Schema

```json
{
  "type": "object",
  "title": "HealthTrendSummaryOutput",
  "required": ["points"],
  "properties": {
    "points": {
      "type": "array",
      "description": "趋势时间序列点。",
      "items": {
        "type": "object",
        "required": ["timestamp", "value"],
        "properties": {
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "该点代表的时间或时间段起始时间。"
          },
          "value": {
            "type": "number",
            "description": "该时间粒度下的聚合值（平均值或其他统计值）。"
          },
          "count": {
            "type": "integer",
            "description": "该时间粒度内包含的原始记录数量。"
          }
        }
      }
    },
    "stats": {
      "type": "object",
      "description": "总体统计信息。",
      "properties": {
        "min": { "type": "number" },
        "max": { "type": "number" },
        "avg": { "type": "number" },
        "first": { "type": "number" },
        "last": { "type": "number" },
        "slope": {
          "type": "number",
          "description": "基于时间序列拟合的趋势斜率。正数表示整体上升，负数表示整体下降。"
        }
      }
    }
  }
}
```

---

### 5.5 工具：`health_list_metric_types`

#### 5.5.1 功能说明

* 返回某个用户已经记录过的指标类型及其基本统计。
* 用于 AI 初步了解用户的健康数据画像。

#### 5.5.2 输入参数 Schema

```json
{
  "type": "object",
  "title": "HealthListMetricTypesInput",
  "required": ["user_id"],
  "properties": {
    "user_id": {
      "type": "string",
      "description": "用户 ID。"
    }
  }
}
```

#### 5.5.3 输出结果 Schema

```json
{
  "type": "object",
  "title": "HealthListMetricTypesOutput",
  "required": ["metric_types"],
  "properties": {
    "metric_types": {
      "type": "array",
      "description": "该用户历史记录中出现过的指标类型列表。",
      "items": {
        "type": "object",
        "required": ["type", "record_count"],
        "properties": {
          "type": { "type": "string" },
          "record_count": { "type": "integer" },
          "first_timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "last_timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "example_value": {
            "oneOf": [
              { "type": "number" },
              { "type": "string" },
              { "type": "object", "additionalProperties": true }
            ]
          },
          "example_unit": { "type": "string" }
        }
      }
    }
  }
}
```

---

### 5.6 工具：`health_get_metric_catalog`

#### 5.6.1 功能说明

* 返回系统当前支持的标准指标字典。
* 便于 AI 在汇报数据前，先了解有哪些 type 可以用。

#### 5.6.2 输入参数 Schema

```json
{
  "type": "object",
  "title": "HealthGetMetricCatalogInput",
  "properties": {
    "category": {
      "type": "string",
      "description": "可选，按大类过滤，如 body、medical、sport。"
    }
  }
}
```

#### 5.6.3 输出结果 Schema

```json
{
  "type": "object",
  "title": "HealthGetMetricCatalogOutput",
  "required": ["metrics"],
  "properties": {
    "metrics": {
      "type": "array",
      "description": "系统支持的标准指标列表。",
      "items": {
        "type": "object",
        "required": ["type_code", "name_zh", "default_unit", "value_type"],
        "properties": {
          "type_code": { "type": "string" },
          "category": { "type": "string" },
          "name_zh": { "type": "string" },
          "name_en": { "type": "string" },
          "description": { "type": "string" },
          "default_unit": { "type": "string" },
          "value_type": { "type": "string" },
          "value_schema": { "type": "object" },
          "default_tags": { "type": "object" }
        }
      }
    }
  }
}
```

---

### 5.7 工具：`health_delete_record`

#### 5.7.1 功能说明

* 删除指定的一条健康记录。
* 仅允许删除属于该用户的记录。

#### 5.7.2 输入参数 Schema

```json
{
  "type": "object",
  "title": "HealthDeleteRecordInput",
  "required": ["user_id", "record_id"],
  "properties": {
    "user_id": {
      "type": "string",
      "description": "用户 ID。用于权限校验。"
    },
    "record_id": {
      "type": "string",
      "description": "要删除的记录 ID。"
    }
  }
}
```

#### 5.7.3 输出结果 Schema

```json
{
  "type": "object",
  "title": "HealthDeleteRecordOutput",
  "required": ["success"],
  "properties": {
    "success": {
      "type": "boolean",
      "description": "是否删除成功。"
    },
    "message": {
      "type": "string",
      "description": "错误或提示信息，例如记录不存在、权限不足等。"
    }
  }
}
```

---

## 6. AI 使用规范与提示词要点（Summary）

在 AI 系统提示词中需要明确以下规则：

1. 所有健康数据的 `type` 必须优先从 `health_get_metric_catalog` 返回的 `type_code` 中选择。
2. 当用户给出新的测量值 / 运动信息 / 报告数据时，应调用：

   * 单条：`health_store_metric`
   * 多条：`health_batch_store_metrics`
3. 对趋势类问题（“有没有变好/变坏”、“趋势如何”），优先调用 `health_trend_summary`。
4. 查询历史具体数值时调用 `health_query_metrics`。
5. 不确定用户已有数据结构时，可以先调用 `health_list_metric_types`。
6. 文档/截图解析应在 AI 侧完成，Server 只接受结构化调用：

   * 文档：`source = "ocr_document"`
   * 截图：`source = "app_screenshot"`
7. 无法在字典中找到完全匹配的指标名时：

   * 尽量找到语义上最接近的 `type_code`
   * 找不到时使用 `custom/...` 命名空间，并在 `tags.original_name` 中写入原始名称。
8. 删除请求必须先确认用户意图并选定唯一记录，再调用 `health_delete_record`。

---

## 7. 非功能需求

### 7.1 性能

* 单次 `health_store_metric` / `health_query_metrics` 接口平均响应时间 ≤ 200ms（在常规数据量下）。
* 支持百万级记录量的存储与查询。
* 常用查询（最近 N 条、最近一段时间）应结合 Redis 缓存优化。

### 7.2 安全与隐私

* 通过 Token / API Key 进行鉴权，保证只有授权的 AI 应用可以调用。
* 支持 HTTPS 部署。
* 尽量不存储用户真实姓名等敏感识别信息，而是使用匿名 `user_id`。
* 预留“用户数据导出 / 删除全量数据”的接口（后续版本）。

### 7.3 可运维性

* 提供基础监控指标：QPS、错误率、平均响应时间、数据库连接数、Redis 命中率等。
* 日志记录每次 MCP 工具调用的输入摘要与执行结果（注意隐私脱敏）。
* 通过 docker-compose 一键启动和关闭服务。

---

## 8. 部署需求

### 8.1 docker-compose 中的服务组件

* `app`：FastAPI 应用 + MCP Server 实现
* `mysql`：健康数据持久化数据库，挂载数据卷
* `redis`：缓存与简易队列
* `adminer`（可选）：数据库 Web 管理工具，仅用于开发环境

### 8.2 配置项

通过环境变量配置：

* `MYSQL_HOST` / `MYSQL_PORT` / `MYSQL_USER` / `MYSQL_PASSWORD` / `MYSQL_DB`
* `REDIS_HOST` / `REDIS_PORT`
* `APP_PORT`
* `APP_ENV`（dev / prod）
* `LOG_LEVEL`

---

## 9. 后续扩展方向（非本期）

* 支持 GPX/TCX 文件解析（跑步轨迹文件）。
* 支持 PDF 体检报告原文的索引与搜索（使用向量数据库）。
* 支持自定义指标（用户自定义 type_code 与 value_schema）。
* 支持健康告警规则（例如连续 N 次指标超出参考值范围）。
